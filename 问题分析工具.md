# MAT 内存分析工具

Memery Analyzer Tool(MAT，内存分析工具), 可以详细的统计了堆中各对象之间的关系以及占用的内存大小。通过 MAT 提供的各种视图以及工具，可以快速的定位问题所在并进行代码的优化。并且该工具可以检测到简单的内存泄漏问题。

## 概念

- outgoing reference: 指的是当前对象引用的其他对象， 例如: A -> B
- incoming reference: 指的是当前对象被其他对象所引用, 例如: A <- C
- dominator: A 支配 B 表示的是当 A 被回收，则 B 也需要回收。例如引用关系是： A -> B -> C -> D，对象 A，B，C，D 除了上述的引用关系，再没有其他的引用关系。根据上述的引用关系可以得出：A 对象是可以支配 B,C,D 对象的， B 对象是可以支配 C，D 对象的，C 对象是可以支配 D 对象的。
- inspector: inspector 面板可以展示对象的详细信息，如静态属性，实例属性，内存地址，类继承关系，所属包，类加载器，GC Roots 等详细信息。通过 inspector 面板可以直接查看业务相关的信息，如某个用户的好友等
- Histogram: 直方图会罗列每个类对应的实例数量，类实例数量占用的内存比例。当 dominator treee 无法明显的看出问题时，可以通过直方图进一步查看各类实例所占的内存。
- Collection Fill Ratio: 集合填充率，当内存中有大量的集合类占据内存时，可以查看集合的填充率如何，如果集合的填充率低，说明内存浪费了大量的内存。
- OQL: Object Query Language, 对象查询语言，根据条件筛选出堆中的对象

## 技巧

```ad-tip
在排查内存泄漏时，建议选择 exclude all phantom/weak/soft 选项来排除虚引用/弱引用/软引用等的引用链，因为被虚引用/弱引用/软引用的对象可以直接被 GC 给回收，聚焦在对象否还存在强引用链即可。
```

# 参考文章

- https://juejin.cn/post/6908665391136899079#heading-0

# JVM 调优工具

问题排查常用的工具有：jvisualvm, mat

- jvisualvm 可以实时查看一个 java 程序中堆中各分区的变化(需要通过一个插件来实现)，是否发生了死锁，线程占用 CPU 的情况。
- mat 主要用于查看内存泄漏，程序各对象占用的内存大小，根据出度、入度结构图以及支配树查看是否可以进一步的优化。